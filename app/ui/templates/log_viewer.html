{% extends "base.html" %}

{% block title %}View Log | StockAI{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        /* Adjust based on header */
    }

    .log-viewer {
        flex: 1;
        background: #1e1e1e;
        /* VS Code-like background */
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        overflow: auto;
        font-family: 'JetBrains Mono', monospace;
        /* Monospaced font */
        font-size: 13px;
        line-height: 1.6;
        color: #d4d4d4;
        white-space: pre-wrap;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* Log coloring based on keyword */
    .log-line {
        display: block;
    }

    .log-line:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .file-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 10px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
        color: var(--text-primary);
    }

    .info-text {
        color: var(--text-secondary);
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="toolbar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <a href="/logs" class="btn btn-outline" style="padding: 8px 12px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 style="font-size: 20px; font-weight: 600; margin: 0;">Log Viewer</h1>
        <span class="file-badge">{{ filename }}</span>
    </div>

    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="info-badge" class="info-text hidden-mobile">Loading info...</span>
        <a href="/api/logs/{{ filename }}/download" class="btn btn-primary btn-sm">
            <i class="fas fa-download"></i> <span class="hidden-mobile">Download</span>
        </a>
    </div>
</div>

<div class="log-container">
    <div id="log-content" class="log-viewer">
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <div style="margin-top: 15px; color: var(--text-muted);">Fetching log data...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadLogContent() {
        try {
            const response = await fetch(`/api/logs/{{ filename }}`);
            const result = await response.json();

            if (result.error) throw new Error(result.error);

            // Update info badge
            const infoBadge = document.getElementById('info-badge');
            if (result.total_lines && result.showing_lines) {
                infoBadge.textContent = result.total_lines > result.showing_lines
                    ? `Showing last ${result.showing_lines} of ${result.total_lines} lines`
                    : `Showing all ${result.showing_lines} lines`;
            }

            // Render content
            const contentDiv = document.getElementById('log-content');
            if (!result.content) {
                contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Log file is empty</div>';
                return;
            }

            // Simple syntax highlighting support
            // We'll wrap lines to allow for future coloring logic if needed
            contentDiv.textContent = result.content;

            // Scroll to bottom (latest logs typically at bottom, though user requested latest first.
            // Wait, the API returns latest first (reversed). So we're at top naturally.
            // If the user wants latest logs at the top, scroll to top is correct.
            contentDiv.scrollTop = 0;

        } catch (error) {
            document.getElementById('log-content').innerHTML = `
                <div class="text-center p-5 text-danger">
                    <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                    <h3>Error reading log</h3>
                    <p>${error.message}</p>
                </div>`;
        }
    }

    loadLogContent();
</script>
{% endblock %}