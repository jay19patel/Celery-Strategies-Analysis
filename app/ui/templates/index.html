{% extends "base.html" %}

{% block title %}Dashboard | StockAI{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard specific styles */
    .filters-card {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-group {
        flex: 1;
        min-width: 300px;
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }

    .search-input {
        padding-left: 45px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        height: 50px;
        border-radius: 12px;
        width: 100%;
        font-size: 16px;
        transition: all 0.2s;
    }

    .search-input:focus {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Table Styling */
    .table-container {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
    }

    .data-table th {
        background: rgba(0, 0, 0, 0.2);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
        padding: 16px;
        border-bottom: 2px solid var(--border-color);
        text-align: left;
    }

    .data-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        color: var(--text-primary);
        transition: background 0.2s;
    }

    .data-table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    /* Batch Grouping */
    .batch-group-odd td {
        background: rgba(255, 255, 255, 0.01);
    }

    .batch-group-even td {
        background: transparent;
    }

    /* Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        border: 1px solid transparent;
    }

    .status-buy {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: rgba(16, 185, 129, 0.2);
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.1);
    }

    .status-sell {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-color: rgba(239, 68, 68, 0.2);
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.1);
    }

    .status-hold {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border-color: rgba(245, 158, 11, 0.2);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }

    .page-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        background: var(--primary);
        border-color: var(--primary);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Mobile Card View */
    .mobile-card-view {
        display: none;
    }

    @media (max-width: 768px) {
        .table-container {
            display: none;
            /* Hide table on mobile */
        }

        .mobile-card-view {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-symbol {
            font-size: 18px;
            font-weight: 700;
        }

        .card-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .card-label {
            color: var(--text-secondary);
        }

        .card-value {
            font-weight: 500;
        }

        .search-group {
            min-width: 100%;
        }
    }

    .loading-state {
        padding: 60px;
        text-align: center;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
    <p>Real-time stock analysis and strategy performance monitoring</p>
</div>

<!-- Filters -->
<div class="card filters-card mb-4 glass-card">
    <div class="search-group">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="search" class="search-input" placeholder="Search symbol, strategy, or signal type...">
    </div>

    <div class="flex-center gap-2" style="color: var(--text-muted); font-size: 13px;">
        <i class="fas fa-info-circle"></i>
        <span>Live updates enabled</span>
    </div>
</div>

<!-- Desktop Table View -->
<div class="card table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Batch ID</th>
                <th>Strategy</th>
                <th>Symbol</th>
                <th>Time</th>
                <th>Signal</th>
                <th>Confidence</th>
                <th>Price</th>
                <th>Exec Time</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- Populated by JS -->
            <tr>
                <td colspan="9" class="loading-state">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 10px">Loading analysis data...</div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Mobile Card View -->
<div class="mobile-card-view" id="mobile-list">
    <!-- Populated by JS -->
</div>

<!-- Pagination -->
<div class="pagination-container" id="pagination">
    <!-- Populated by JS -->
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 20;

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Load data
    async function loadData(page = 1) {
        // Show loading state
        const tbody = document.getElementById('table-body');
        const mobileList = document.getElementById('mobile-list');

        if (page !== currentPage) {
            // Optional: Scroll to top of results on page change
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        try {
            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                search: document.getElementById('search').value
            });

            const response = await fetch(`/api/data?${params}`);
            const result = await response.json();

            if (result.error) throw new Error(result.error);

            renderData(result.data);
            renderPagination(result.pagination);
            currentPage = page;

        } catch (error) {
            const errorHtml = `
                <tr>
                    <td colspan="9" class="loading-state text-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <br>
                        Error: ${error.message}
                    </td>
                </tr>`;

            tbody.innerHTML = errorHtml;
            mobileList.innerHTML = `<div class="card text-danger text-center p-4">Error: ${error.message}</div>`;
        }
    }

    function renderData(data) {
        const tbody = document.getElementById('table-body');
        const mobileList = document.getElementById('mobile-list');

        if (data.length === 0) {
            const emptyHtml = `
                <tr>
                    <td colspan="9" class="loading-state">
                        <i class="fas fa-inbox fa-2x mb-3"></i><br>
                        No data found
                    </td>
                </tr>`;
            tbody.innerHTML = emptyHtml;
            mobileList.innerHTML = `<div class="card text-center text-muted p-4">No data found</div>`;
            return;
        }

        // Batch identification for grouping
        let batchColorMap = new Map();
        let seenBatchIds = [];
        data.forEach(row => {
            const batchId = row.batch_id || '';
            if (batchId && !seenBatchIds.includes(batchId)) {
                seenBatchIds.push(batchId);
            }
        });
        seenBatchIds.forEach((batchId, index) => {
            batchColorMap.set(batchId, index % 2 === 0 ? 'even' : 'odd');
        });

        // Render Desktop Table
        tbody.innerHTML = data.map(row => {
            const dateTime = formatDateTime(row.datetime);
            const signalClass = getSignalClass(row.signal_type);
            const batchClass = `batch-group-${batchColorMap.get(row.batch_id || '')}`;
            const shortBatchId = (row.batch_id || '').substring(0, 8);

            return `
                <tr class="${batchClass}">
                    <td class="text-muted" title="${row.batch_id}">#${shortBatchId}</td>
                    <td>${row.strategy_name || 'N/A'}</td>
                    <td><b style="color: var(--text-primary)">${row.symbol || 'N/A'}</b></td>
                    <td class="text-muted" style="font-size: 13px;">${dateTime}</td>
                    <td>
                        <span class="status-badge ${signalClass}">
                            ${getSignalIcon(row.signal_type)}
                            ${row.signal_type || 'HOLD'}
                        </span>
                    </td>
                    <td>${((row.confidence || 0) * 100).toFixed(1)}%</td>
                    <td>$${(row.price || 0).toFixed(2)}</td>
                    <td class="text-muted">${(row.execution_time || 0).toFixed(3)}s</td>
                    <td>${row.success ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                </tr>
            `;
        }).join('');

        // Render Mobile Cards
        mobileList.innerHTML = data.map(row => {
            const dateTime = formatDateTime(row.datetime);
            const signalClass = getSignalClass(row.signal_type);

            return `
                <div class="result-card">
                    <div class="card-header">
                        <div>
                            <div class="card-symbol">${row.symbol || 'N/A'}</div>
                            <div class="card-time">${dateTime}</div>
                        </div>
                        <span class="status-badge ${signalClass}">
                            ${row.signal_type || 'HOLD'}
                        </span>
                    </div>
                    
                    <div class="card-row">
                        <span class="card-label">Strategy</span>
                        <span class="card-value">${row.strategy_name || 'N/A'}</span>
                    </div>
                    
                    <div class="card-row">
                        <span class="card-label">Price</span>
                        <span class="card-value">$${(row.price || 0).toFixed(2)}</span>
                    </div>
                    
                    <div class="card-row">
                        <span class="card-label">Confidence</span>
                        <span class="card-value">${((row.confidence || 0) * 100).toFixed(1)}%</span>
                    </div>
                    
                    <div class="card-row">
                        <span class="card-label">Batch ID</span>
                        <span class="card-value text-muted" style="font-family: monospace">#${(row.batch_id || '').substring(0, 8)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPagination(pagination) {
        const div = document.getElementById('pagination');
        const { page, total_pages } = pagination;

        if (total_pages <= 1) {
            div.innerHTML = '';
            return;
        }

        let html = `
            <button class="page-btn" onclick="loadData(1)" ${page === 1 ? 'disabled' : ''}>
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button class="page-btn" onclick="loadData(${page - 1})" ${page === 1 ? 'disabled' : ''}>
                <i class="fas fa-angle-left"></i>
            </button>
            
            <span style="font-size: 14px; margin: 0 10px; color: var(--text-secondary)">
                Page ${page} of ${total_pages}
            </span>
            
            <button class="page-btn" onclick="loadData(${page + 1})" ${page >= total_pages ? 'disabled' : ''}>
                <i class="fas fa-angle-right"></i>
            </button>
            <button class="page-btn" onclick="loadData(${total_pages})" ${page >= total_pages ? 'disabled' : ''}>
                <i class="fas fa-angle-double-right"></i>
            </button>
        `;

        div.innerHTML = html;
    }

    // Helpers
    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        try {
            let date = new Date(dateStr);
            // Check if valid
            if (isNaN(date.getTime())) {
                // Try appending Z if missing timezone
                if (dateStr.indexOf('Z') === -1 && dateStr.indexOf('+') === -1) {
                    date = new Date(dateStr + "Z");
                }
            }
            if (isNaN(date.getTime())) return dateStr;

            return date.toLocaleString('en-IN', {
                month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit',
                hour12: true
            });
        } catch (e) {
            return dateStr;
        }
    }

    function getSignalClass(signal) {
        const s = (signal || '').toUpperCase();
        if (s === 'BUY') return 'status-buy';
        if (s === 'SELL') return 'status-sell';
        return 'status-hold';
    }

    function getSignalIcon(signal) {
        const s = (signal || '').toUpperCase();
        if (s === 'BUY') return '<i class="fas fa-arrow-up"></i>';
        if (s === 'SELL') return '<i class="fas fa-arrow-down"></i>';
        return '<i class="fas fa-minus"></i>';
    }

    // Init
    document.getElementById('search').addEventListener('input', debounce(() => loadData(1), 500));
    loadData(1);
</script>
{% endblock %}