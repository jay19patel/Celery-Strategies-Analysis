{% extends "base.html" %}

{% block title %}Dashboard | StockAI{% endblock %}

{% block content %}
<div class="mb-8 pl-1">
    <h1 class="text-2xl font-semibold mb-2 bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">
        Dashboard</h1>
    <p class="text-gray-500 text-sm">Real-time stock analysis and strategy performance monitoring</p>
</div>

<!-- Filters -->
<div class="bg-dark-card border border-dark-border rounded-xl p-6 mb-6 shadow-sm backdrop-blur-md bg-opacity-70">
    <div class="flex flex-wrap gap-6 items-center justify-between">
        <!-- Search -->
        <div class="flex-1 min-w-[300px] relative">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
            <input type="text" id="search"
                class="w-full h-[50px] pl-11 bg-white/[0.03] border border-dark-border text-white rounded-xl text-base transition-all focus:bg-white/[0.05] focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none"
                placeholder="Search symbol, strategy, or signal type...">
        </div>

        <!-- Active Filter -->
        <div class="flex items-center gap-4 border-l border-dark-border pl-6">
            <label class="relative inline-block w-12 h-6 cursor-pointer">
                <input type="checkbox" id="filter-toggle" onchange="loadData(1)" class="peer sr-only">
                <div
                    class="w-full h-full bg-dark-border rounded-full peer-checked:bg-blue-500 transition-all after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all peer-checked:after:translate-x-6 focus:ring-2 focus:ring-blue-500/20">
                </div>
            </label>
            <div>
                <div class="font-semibold text-white text-sm">Show Active Sides Only</div>
                <div class="text-xs text-gray-500">Filter BUY/SELL signals ("Non Hold")</div>
            </div>
        </div>

        <div class="flex items-center gap-2 text-gray-500 text-[13px]">
            <i class="fas fa-info-circle"></i>
            <span>Live updates enabled</span>
        </div>
    </div>
</div>

<!-- Desktop Table View -->
<div class="hidden md:block bg-dark-card border border-dark-border rounded-xl overflow-x-auto">
    <table class="w-full border-collapse white-space-nowrap">
        <thead>
            <tr>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Batch ID</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Strategy</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Symbol</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Time</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Signal</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Confidence</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Price</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Exec Time</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Subscribers</th>
                <th
                    class="bg-black/20 text-gray-500 font-semibold uppercase text-xs tracking-wide p-4 border-b-2 border-dark-border text-left">
                    Status</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- Populated by JS -->
            <tr>
                <td colspan="10" class="p-16 text-center text-gray-500">
                    <div
                        class="inline-block w-5 h-5 border-2 border-white/30 border-t-blue-500 rounded-full animate-spin">
                    </div>
                    <div class="mt-2.5">Loading analysis data...</div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Mobile Card View -->
<div class="md:hidden flex flex-col gap-4" id="mobile-list">
    <!-- Populated by JS -->
</div>

<!-- Pagination -->
<div class="flex justify-center items-center gap-2.5 mt-8" id="pagination">
    <!-- Populated by JS -->
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 20;

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Load data
    async function loadData(page = 1) {
        // Show loading state
        const tbody = document.getElementById('table-body');
        const mobileList = document.getElementById('mobile-list');
        const showBuySell = document.getElementById('filter-toggle') ? document.getElementById('filter-toggle').checked : false;

        if (page !== currentPage) {
            // Optional: Scroll to top of results on page change
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        try {
            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                search: document.getElementById('search').value,
                show_buy_sell_only: showBuySell
            });

            const response = await fetch(`/api/data?${params}`);
            const result = await response.json();

            if (result.error) throw new Error(result.error);

            renderData(result.data);
            renderPagination(result.pagination);
            currentPage = page;

        } catch (error) {
            const errorHtml = `
                <tr>
                    <td colspan="10" class="loading-state text-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <br>
                        Error: ${error.message}
                    </td>
                </tr>`;

            tbody.innerHTML = errorHtml;
            mobileList.innerHTML = `<div class="card text-danger text-center p-4">Error: ${error.message}</div>`;
        }
    }

    function renderData(data) {
        const tbody = document.getElementById('table-body');
        const mobileList = document.getElementById('mobile-list');

        if (data.length === 0) {
            const emptyHtml = `
                <tr>
                    <td colspan="10" class="p-16 text-center text-gray-500">
                        <i class="fas fa-inbox fa-2x mb-3"></i><br>
                        No data found
                    </td>
                </tr>`;
            tbody.innerHTML = emptyHtml;
            mobileList.innerHTML = `<div class="bg-dark-card border border-dark-border rounded-xl p-8 text-center text-gray-500">No data found</div>`;
            return;
        }

        // Batch identification for grouping
        let batchColorMap = new Map();
        let seenBatchIds = [];
        data.forEach(row => {
            const batchId = row.batch_id || '';
            if (batchId && !seenBatchIds.includes(batchId)) {
                seenBatchIds.push(batchId);
            }
        });
        seenBatchIds.forEach((batchId, index) => {
            batchColorMap.set(batchId, index % 2 === 0 ? 'bg-transparent' : 'bg-white/[0.01]');
        });

        // Render Desktop Table
        tbody.innerHTML = data.map(row => {
            const dateTime = formatDateTime(row.timestamp);
            const signalClass = getSignalClass(row.signal_type);
            const batchClass = batchColorMap.get(row.batch_id || '');
            const shortBatchId = (row.batch_id || '').substring(0, 8);

            return `
                <tr class="${batchClass} hover:bg-white/[0.02] transition-colors">
                    <td class="p-4 border-b border-dark-border text-sm text-gray-500" title="${row.batch_id}">#${shortBatchId}</td>
                    <td class="p-4 border-b border-dark-border text-sm text-white">${row.strategy_name || 'N/A'}</td>
                    <td class="p-4 border-b border-dark-border text-sm"><b class="text-white">${row.symbol || 'N/A'}</b></td>
                    <td class="p-4 border-b border-dark-border text-sm text-gray-500 text-[13px]">${dateTime}</td>
                    <td class="p-4 border-b border-dark-border text-sm">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold uppercase border ${signalClass}">
                            ${getSignalIcon(row.signal_type)}
                            ${row.signal_type || 'HOLD'}
                        </span>
                    </td>
                    <td class="p-4 border-b border-dark-border text-sm text-white">${((row.confidence || 0) * 100).toFixed(1)}%</td>
                    <td class="p-4 border-b border-dark-border text-sm text-white">$${(row.price || 0).toFixed(2)}</td>
                    <td class="p-4 border-b border-dark-border text-sm text-gray-500">${(row.execution_time || 0).toFixed(3)}s</td>
                    <td class="p-4 border-b border-dark-border text-sm text-gray-500"><i class="fas fa-users mr-1.5"></i>${row.pubsub || 0}</td>
                    <td class="p-4 border-b border-dark-border text-sm">${row.success ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
                </tr>
            `;
        }).join('');

        // Render Mobile Cards
        mobileList.innerHTML = data.map(row => {
            const dateTime = formatDateTime(row.timestamp);
            const signalClass = getSignalClass(row.signal_type);

            return `
                <div class="bg-dark-card border border-dark-border rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-lg font-bold text-white">${row.symbol || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${dateTime}</div>
                        </div>
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold uppercase border ${signalClass}">
                            ${row.signal_type || 'HOLD'}
                        </span>
                    </div>
                    
                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-gray-400">Strategy</span>
                        <span class="font-medium text-white">${row.strategy_name || 'N/A'}</span>
                    </div>
                    
                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-gray-400">Price</span>
                        <span class="font-medium text-white">$${(row.price || 0).toFixed(2)}</span>
                    </div>
                    
                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-gray-400">Confidence</span>
                        <span class="font-medium text-white">${((row.confidence || 0) * 100).toFixed(1)}%</span>
                    </div>

                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-gray-400">Subscribers</span>
                        <span class="font-medium text-white"><i class="fas fa-users mr-1.5 text-[10px]"></i>${row.pubsub || 0}</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Batch ID</span>
                        <span class="text-gray-500 font-mono">#${(row.batch_id || '').substring(0, 8)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPagination(pagination) {
        const div = document.getElementById('pagination');
        const { page, total_pages } = pagination;

        if (total_pages <= 1) {
            div.innerHTML = '';
            return;
        }

        let html = `
            <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-dark-card border border-dark-border text-white transition-all hover:bg-blue-500 hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" onclick="loadData(1)" ${page === 1 ? 'disabled' : ''}>
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-dark-card border border-dark-border text-white transition-all hover:bg-blue-500 hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" onclick="loadData(${page - 1})" ${page === 1 ? 'disabled' : ''}>
                <i class="fas fa-angle-left"></i>
            </button>
            
            <span class="text-sm mx-2.5 text-gray-400">
                Page ${page} of ${total_pages}
            </span>
            
            <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-dark-card border border-dark-border text-white transition-all hover:bg-blue-500 hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" onclick="loadData(${page + 1})" ${page >= total_pages ? 'disabled' : ''}>
                <i class="fas fa-angle-right"></i>
            </button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-dark-card border border-dark-border text-white transition-all hover:bg-blue-500 hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" onclick="loadData(${total_pages})" ${page >= total_pages ? 'disabled' : ''}>
                <i class="fas fa-angle-double-right"></i>
            </button>
        `;

        div.innerHTML = html;
    }

    // Helpers
    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        try {
            let date = new Date(dateStr);
            // Check if valid
            if (isNaN(date.getTime())) {
                // Try appending Z if missing timezone
                if (dateStr.indexOf('Z') === -1 && dateStr.indexOf('+') === -1) {
                    date = new Date(dateStr + "Z");
                }
            }
            if (isNaN(date.getTime())) return dateStr;

            return date.toLocaleString('en-IN', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            });
        } catch (e) {
            return dateStr;
        }
    }

    function getSignalClass(signal) {
        const s = (signal || '').toUpperCase();
        if (s === 'BUY') return 'bg-green-500/10 text-green-500 border-green-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]';
        if (s === 'SELL') return 'bg-red-500/10 text-red-500 border-red-500/20 shadow-[0_0_10px_rgba(239,68,68,0.1)]';
        return 'bg-amber-500/10 text-amber-500 border-amber-500/20';
    }

    function getSignalIcon(signal) {
        const s = (signal || '').toUpperCase();
        if (s === 'BUY') return '<i class="fas fa-arrow-up"></i>';
        if (s === 'SELL') return '<i class="fas fa-arrow-down"></i>';
        return '<i class="fas fa-minus"></i>';
    }

    // Init
    document.getElementById('search').addEventListener('input', debounce(() => loadData(1), 500));
    loadData(1);
</script>
{% endblock %}